# 小程序的云开发

开发语言：node.js，不需要域名，不需要支持https，免费版基本够用。

## 云函数的调用

通过以下代码重新设置环境

~~~
wx.cloud.init({
	env:'环境id'
})
~~~

## 1.云开发数据库





控制台如果不输出？在云开发控制台数据库中修改数据权限为“所有用户可读”。

### 1.提供的数据类型

```
string   字符串
number   数字
object   对象
array    数组
bool     布尔值
date     时间
geo      多种地理位置
null
```

### 2.数据的操作

#### 1.初始化

~~~
const db = wx.cloud.database()   //获取默认环境下的数据库
const dbTest = wx.cloud.database({env:'test'})       //获取指定环境下的数据库
const todos = db.collection('todos')  //获取指定集合的数据
const todo = db.collection('todos').doc('hello')   //获取指定集合内id=hello的一条记录
~~~

#### 2.逻辑指令

```
where()
and()
and([,])      //与
or()          //或
or([,])
gt()         //大于
gte()        //大于或等于
lt()         //小于
lte()        //小于或等于
eq()         //等于
neq()        //不等于
in()         //包含
nin()        //不包含

```

#### 3.数据的增加 .add()

```
onLoad:function(options){
wx.cloud.init({
    env:'lumos-0gkm42kq64a8a6a1'
  })                                   //绑定数据库环境
const db = wx.cloud.database()                      //调用环境数据的引用
const banner = db.collection('tables')              //调用的数据库里的叫做"tables"的集合

//数据的插入
banner.add({
  data:{                                          //插入的数据，注意要写上data
  add_time:'2021-08-06',
  _id:'011',                             
  name:"javascript",
  age:20
  }
})

.then(res=>{
  console.log(res)
})
.catch(err=>{
  console.log(err)
})
}
```



##### insert插入

回调风格：传入success/fail/complet

```
db.collection('todos').add({
	data:{...},
	success:function(res){...}
})
```

##### Promise风格

不传入success...

```\
db.collection('todos').add({
	data:{...}
}).then(res=>{...})
```

Promise的then方法用来添加回调函数。

#### 4.数据的查询 .get()

```
onLoad:function(options){
wx.cloud.init({
    env:'lumos-0gkm42kq64a8a6a1'
  })                                   //绑定数据库环境
const db = wx.cloud.database()                      //调用环境数据的引用
const banner = db.collection('tables')              //调用的数据库里的叫做"tables"的集合

banner.where({                        //在banner内查询有没有name是hello的
	name:'hello'
})

.get()                          //发送请求数据
.then(res=>{                    //查找成功
	console.log(res)            //在控制台输出
})
.catch(err=>{                   //查找失败
	console.log(err)
})
}
```

查询的时候要分清楚查询的数据类型

```
name:"string"                //字符串
age:number                  //数字类型
```



##### 回调风格

```
//数据查询
db.collection('todos').doc('hello').get({
	success:function(res){...}
})
```



##### Promise风格

```
db.collection('todos').doc('hello').get().then(res => {...})
```



#### 5.数据的更新 .update()

```
onLoad:function(options){
wx.cloud.init({
    env:'lumos-0gkm42kq64a8a6a1'
  })                                   //绑定数据库环境
const db = wx.cloud.database()                      //调用环境数据的引用
const banner = db.collection('tables')              //调用的数据库里的叫做"tables"的集合

//数据的局部更新：只是将要更新的数据进行更新
banner.doc('被更新的数据的_id').update
({
	data:
	{
	   //要更新的新数据
	}
})

//数据的全局更新：将更新的数据覆盖原数据
banner.doc('被更新的数据的_id').set
({
	data:
	{
	   //要更新的新数据
	}
})

.then(res=>{
  console.log(res)
})
.catch(err=>{
  console.log(err)
})
}
```



```
db.collection('').doc('hello').update(data:{...},success:function(res){...})
```



#### 6.数据的删除 .remove()

```
onLoad:function(options){
wx.cloud.init({
    env:'lumos-0gkm42kq64a8a6a1'
  })                                   //绑定数据库环境
const db = wx.cloud.database()                      //调用环境数据的引用
const banner = db.collection('tables')              //调用的数据库里的叫做"tables"的集合

//删除数据
.banner.doc('被删除的数据_id').remove({})

.then(res=>{                    //查找成功
	console.log(res)            //在控制台输出
})
.catch(err=>{                   //查找失败
	console.log(err)
})
}
```



```
db.collection('todos').doc('hello').remove({
	success:function(res){
		console.log(res.data)
	}
})
```



## 2.云存储



 #### 1.直接上传文件

![image-20210805145244506](C:\Users\kEEpkind-\AppData\Roaming\Typora\typora-user-images\image-20210805145244506.png)





#### 2.通过代码上传

##### 1.需要用到API接口

[上传图片API](https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.chooseImage.html)

[将本地资源上传至云存储空间](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/storage/uploadFile/client.uploadFile.html)

##### 2.上传图片

[上传图片API](https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.chooseImage.html)

[将本地资源上传至云存储空间](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/storage/uploadFile/client.uploadFile.html)

首先在.wxml中添加一个按键，并绑定函数

```
<button bindtap="saveimage">上传图片</button>
```

在.js中：

```
onLoad:function(){                               //绑定环境
  wx.cloud.init({
    env:'lumos-0gkm42kq64a8a6a1'
  })  
},


saveimage(){
  wx.chooseImage({                             //上传图片的API
    count: 1,
    success:(res)=>{                          //上传图片成功执行
      console.log(res)
      wx.cloud.uploadFile({                   //将本地资源上传到云存储函数
                                               //上传到云存储后的路径
                                          //cloudPath:'O/ooo'       //在文件夹O里名称叫做ooo
        cloudPath:'ooo',          //不在文件夹里  名称叫做ooo         
        filePath:res.tempFilePaths[0],        //小程序临时文件路径
        success:(res)=>{                      //上传图片到云存储成功执行
          console.log(res)
        },
        fail:(err)=>{                         //上传图片到云存储失败执行
          console.log(err)
        }
      })
    },
    fail:(err)=>{                           //上传图片失败执行
      console.log(err)
    },
  })
  
}
```

##### 3.下载文件

[wx.cloud.downloadFile](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/storage/downloadFile/client.downloadFile.html)

```
//下载文件
download(){
wx.cloud.downloadFile({                         //下载文件API
  fileID:'',                                    //下载的文件ID
  success:(res)=>{
    console.log(res)
  },
  fail:(err)=>{
    console.log(err)
  }
})
}
```

##### 4.删除文件

```
//删除文件
delete(){
  wx.cloud.deleteFile({
    fileList:[''],                       //填入需要删除的文件的File ID，一次最多可以删除50个
    success:(res)=>{
      console.log(res)
    },
    fail:(err)=>{
      console.log(err)
    }
  })
}
```



## 3.云函数

![image-20210809110737117](C:\Users\kEEpkind-\AppData\Roaming\Typora\typora-user-images\image-20210809110737117.png)

云函数是在云端（服务器端）运行的函数。

[云函数微信开放文件](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions.html)

```
//云函数入口文件
const cloud = require('wx-server-sdk')


//async es7的异步
//event 接收前端传来的数据

cloud.init()
exports.main = async(event,context)=>{
return{
      //返回的函数
}
}

//上传云函数 

//前端调用后端云函数
函数名(){
wx.cloud.callFunction({
//name指定云函数名称
name:'page',
data:{
//要传到后端的数据
}
success:(res)=>{
console.log(res)
},
fail:(err)=>{
console.log(err)
}
})
}
```

#### async await promise的异步等待

[异步返回结果](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/async.html)

##### 1.aysnc

aysnc是什么？

- sysnc用于**申明异步**，常常用于**处理回调函数**

- sysnc返回一个**promise**的对象，可以直接用**.then .catch**来处理结果

##### 2.await

await是什么？

- 会阻止后面的代码运行，因为他后面的代码会等待上一个await完成(resolve)

```
// index.js
exports.main = async (event, context) => {
  return new Promise((resolve, reject) => {
    // 在 3 秒后返回结果给调用方（小程序 / 其他云函数）
    setTimeout(() => {
      resolve(event.a + event.b)
    }, 3000)
  })
}


wx.cloud.callFunction({
  name: 'test',
  data: {
    a: 1,
    b: 2,
  },
  complete: res => {
    console.log('callFunction test result: ', res)
  },
})
```

#### 1.云函数的初始化

1.首先新建一个文件夹，如cloud

2.在project.config.json里面配置云函数所在目录为cloud

3.成功后cloud文件夹前面就有一个云

![image-20210809142026357](C:\Users\kEEpkind-\AppData\Roaming\Typora\typora-user-images\image-20210809142026357.png)

#### 2.调用云函数

##### 1.success 和 fail

```
let that=this
wx.cloud.callFunction({
	name:'getData',
	success(res){
		console.log('',res)
		that.setData({
		openid:res.result.openid
	})
},
	fail(err){
	console.log('请求云函数失败',err)
	}
})
```



##### 2.then 和catch

```
wx.cloud.callFunction({
	name:'getData'
})
	.then(res=>{
	console.log('成功'.res)
	this.setData({
		openid:res.result.openid
	})
	})
	.catch(res=>{
		console.log('失败',res)
	})
```





